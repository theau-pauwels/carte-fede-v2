---
import Layout from "@layouts/Layout.astro";
const next = Astro.url.searchParams.get("next") || "/"; // redir après inscription
---
<Layout title="Inscription">
  <main class="flex-1 flex flex-col gap-4 items-center p-4 justify-center">
    <section class="w-full max-w-md">
      <h1 class="font-semibold text-2xl text-blue-800 bg-white mb-1">Créer un compte</h1>

      <form id="signupForm" class="stack" novalidate>
        <label>
          Nom
          <input
            id="nom"
            name="nom"
            type="text"
            placeholder="Votre nom"
            required
            class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </label>

        <label>
          Prénom
          <input
            id="prenom"
            name="prenom"
            type="text"
            placeholder="Votre prénom"
            required
            class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </label>

        <label>
          Email UMONS
          <input
            id="email"
            name="email"
            type="email"
            placeholder=""
            autocomplete="username"
            required
            class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </label>

        <label>
          Mot de passe
          <input
            id="password"
            name="password"
            type="password"
            placeholder="••••••••"
            autocomplete="new-password"
            required
            class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </label>

        <label>
          Confirmer le mot de passe
          <input
            id="password2"
            name="password2"
            type="password"
            placeholder="••••••••"
            autocomplete="new-password"
            required
            class="border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </label>

        <button
          type="submit"
          class="rounded-lg border-2 border-blue-900 bg-blue-900 px-4 py-2 text-white transition duration-150 hover:bg-blue-50 hover:text-blue-900"
        >
          S'inscrire
        </button>
        <p id="err" style="color:#b00;"></p>
      </form>

      <style>
        .stack {
          display: flex;
          flex-direction: column;
          gap: 0.8rem;
          max-width: 380px;
        }
        input,
        button {
          padding: 0.55rem 0.7rem;
          font-size: 1rem;
        }
      </style>
    </section>
  </main>
</Layout>

<script>
  async function guard() {
    const r = await fetch('/api/me', { credentials: 'include' });
    if (!r.ok) return location.href = '/login?next=' + encodeURIComponent(location.pathname);
    const me = await r.json();
    if (me.role !== 'admin') return location.href = '/';
    document.getElementById('who').textContent = `Connecté : ${me.email} (${me.role})`;
  }
  guard();



  const form = document.getElementById('signupForm');
  const $err = document.getElementById('err');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    $err.textContent = '';

    const nom = document.getElementById('nom').value.trim();
    const prenom = document.getElementById('prenom').value.trim();
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const password2 = document.getElementById('password2').value;

    if (!nom || !prenom || !email || !password || !password2) {
      $err.textContent = "Tous les champs sont obligatoires.";
      return;
    }

    if (password !== password2) {
      $err.textContent = "Les mots de passe ne correspondent pas.";
      return;
    }

    const res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      credentials: 'include',
      body: JSON.stringify({ nom, prenom, email: email.toLowerCase(), password })
    });

    if (!res.ok) {
      try {
        const j = await res.json();
        $err.textContent = j.error || ('Erreur ' + res.status);
      } catch {
        $err.textContent = 'Erreur ' + res.status;
      }
      return;
    }

    // OK → redirige
    const next = new URLSearchParams(window.location.search).get('next') || '/';
    location.href = next;
  });
</script>
